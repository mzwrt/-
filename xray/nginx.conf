# 别忘记修改路径
location /XXXXX {
    # 限制只有 GET 请求可以访问
    if ($request_method !~ ^(GET)$) {
        return 405;
    }

    # 禁用代理重定向
    proxy_redirect off;

    # 禁用请求缓冲
    proxy_buffering off;
    proxy_request_buffering off;

    # 转发至后端 Xray
    proxy_pass https://127.0.0.1:8431; # Xray 端口

    # 确保使用 HTTP/1.1 协议以支持 WebSocket
    proxy_http_version 1.1;

    # 禁用接受编码，以避免不必要的压缩
    proxy_set_header Accept-Encoding "";

    # 保持 WebSocket 连接
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # 配置超时
    proxy_read_timeout 60s;  # 后端响应超时
    proxy_send_timeout 60s;  # 客户端请求超时
    proxy_connect_timeout 30s;  # 与后端建立连接超时

    # 可选，调优请求头哈希表
    #proxy_headers_hash_max_size 512;
    #proxy_headers_hash_bucket_size 64;

    # 隐藏一些敏感头部
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;

    # 转发原始 Host 和协议
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 可选：提高日志的详细程度以便于调试
    #access_log /var/log/nginx/iclouddrive_access.log main;
    #error_log /var/log/nginx/iclouddrive_error.log warn;

    # 可选：增加连接数限制来防止过载
    #limit_conn addr 100;  # 每个 IP 限制最大连接数为 100
    #limit_req zone=req_limit_per_ip burst=10 nodelay;  # 限制请求速率，避免滥用

    # 可选：增加缓存策略（如果适用）
    #proxy_cache my_cache;
    #proxy_cache_valid 200 1h;
    #proxy_cache_use_stale error timeout updating;

}
